---
title: "test_EM"
author: "Huanyu Chen"
date: "2024-04-25"
output: html_document
---

```{r}
# 定义 E 步骤函数
E_step <- function(data, mu, sigma, pi, missing) {
  n <- nrow(data)
  k <- length(pi)
  posterior <- matrix(0, n, k)
  
  for (i in 1:k) {
    density <- dnorm(data, mean = mu[i], sd = sigma[i], log = TRUE)
    density[missing] <- 0  # 将缺失值对应位置的概率设为0
    posterior[, i] <- pi[i] * exp(rowSums(density, na.rm = TRUE))
  }
  
  posterior <- posterior / rowSums(posterior)
  
  return(posterior)
}

# 定义 M 步骤函数
M_step <- function(data, posterior) {
  n <- nrow(data)
  k <- ncol(posterior)
  pi <- colMeans(posterior)
  mu <- numeric(k)
  sigma <- numeric(k)
  
  for (i in 1:k) {
    mu[i] <- sum(posterior[, i] * data, na.rm = TRUE) / sum(posterior[, i], na.rm = TRUE)
    sigma[i] <- sqrt(sum(posterior[, i] * (data - mu[i])^2, na.rm = TRUE) / sum(posterior[, i], na.rm = TRUE))
  }
  
  return(list(pi = pi, mu = mu, sigma = sigma))
}

# 定义 EM 算法函数
EM_algorithm <- function(data, k, max_iter = 100, tol = 1e-6) {
  n <- nrow(data)
  p <- ncol(data)
  
  # 初始化模型参数
  mu <- matrix(runif(k * p, min = min(data, na.rm = TRUE), max = max(data, na.rm = TRUE)), nrow = p)
  sigma <- matrix(rep(sd(data, na.rm = TRUE), k * p), nrow = p)
  pi <- rep(1/k, k)
  
  for (iter in 1:max_iter) {
    # E 步骤
    missing <- is.na(data)
    posterior <- E_step(data, mu, sigma, pi, missing)
    
    # M 步骤
    new_params <- M_step(data, posterior)
    
    # 更新参数
    if (max(abs(new_params$mu - mu)) < tol && max(abs(new_params$sigma - sigma)) < tol) {
      break
    }
    
    mu <- new_params$mu
    sigma <- new_params$sigma
    pi <- new_params$pi
  }
  
  return(list(mu = mu, sigma = sigma, pi = pi, posterior = posterior, iter = iter))
}

# 读取数据
data <- read.csv("./data/diabetes.csv")

# 选择要使用的特征列（忽略类变量）
features <- data[, -ncol(data)]

# 运行 EM 算法
result <- EM_algorithm(as.matrix(features), k = 3)

# 输出结果
print(result)
```

